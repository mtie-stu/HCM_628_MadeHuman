@model Madehuman_Share.ViewModel.Outbound.PickTaskFullViewModel

@{
    ViewData["Title"] = "Nhiệm vụ Pick";
    var currentDetail = Model.Details.FirstOrDefault(); // 👉 Tạm thời hiển thị item đầu tiên
}

<div class="container mt-4">
    <h3 class="text-primary mb-3">🧾 Mã nhiệm vụ: <span class="badge bg-secondary">@Model.Id</span></h3>

    @if (currentDetail != null)
    {
        <div class="row mb-4">
            <div class="col-md-6">
                <h5>📦 Sản phẩm cần lấy</h5>
                <p><strong>Tên sản phẩm:</strong> @currentDetail.ProductName</p>
                <p><strong>SKU:</strong> @currentDetail.SkuCode</p>
                <p><strong>Số lượng cần lấy:</strong> @currentDetail.Quantity</p>
                <p><strong>Vị trí cần lấy hàng:</strong> @currentDetail.WarehouseLocationCode</p>
                <p><strong>Mã giỏ hàng:</strong> @Model.BasketId</p>

                <div class="mt-3">
                    <h6>🖼️ Hình ảnh sản phẩm</h6>
                    @if (currentDetail.ImageUrls != null && currentDetail.ImageUrls.Any())
                    {
                        var carouselId = "carousel_" + currentDetail.Id;

                        <div id="@carouselId" class="carousel slide" data-bs-ride="carousel" style="max-width: 300px;">
                            <div class="carousel-inner">
                                @for (int i = 0; i < currentDetail.ImageUrls.Count; i++)
                                {
                                    var img = currentDetail.ImageUrls[i];
                                    <div class="carousel-item @(i == 0 ? "active" : "")">
                                        <img src="@img" class="d-block w-100 rounded" alt="Ảnh sản phẩm">
                                    </div>
                                }
                            </div>
                            @if (currentDetail.ImageUrls.Count > 1)
                            {
                                <button class="carousel-control-prev" type="button" data-bs-target="#@carouselId" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Trước</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#@carouselId" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">Tiếp</span>
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted fst-italic">Không có ảnh.</p>
                    }
                </div>

            </div>
        </div>
    }

    <div class="mb-4">
        <label for="scanInput" class="form-label fw-bold">🔍 Ô nhập dữ liệu quét</label>
        <input type="text" id="scanInput" class="form-control form-control-lg" placeholder="Quét mã vị trí, sản phẩm, giỏ..." autofocus />
    </div>
</div>




@section Scripts {
    <script>
        let step = 1;
        let picked = 0;
        const qtyNeed = parseInt("@currentDetail.Quantity");
        const qtyPickedEl = document.getElementById("qty-picked");
        const resultBox = document.getElementById("result");

        document.getElementById("scanInput").addEventListener("keypress", async function (e) {
            if (e.key !== "Enter") return;

            const value = e.target.value.trim();
            e.target.value = "";

            if (!value) return;

            if (step === 1) {
                // B1: Quét vị trí
                if (value === "@currentDetail.WarehouseLocationId") {
                    step = 2;
                    showSuccess("✅ Vị trí chính xác. Quét SKU tiếp theo.");
                } else {
                    showError("❌ Sai vị trí. Hãy thử lại.");
                }
            } else if (step === 2) {
                // B2: Quét SKU
                if (value === "@currentDetail.ProductSKUId") {
                    picked++;
                    qtyPickedEl.textContent = picked;
                    if (picked < qtyNeed) {
                        showSuccess(`✅ Đã Pick ${picked}/${qtyNeed}. Tiếp tục quét.`);
                    } else {
                        step = 3;
                        showSuccess("✅ Đã đủ số lượng. Quét giỏ để xác nhận.");
                    }
                } else {
                    showError("❌ Sai SKU. Vui lòng thử lại.");
                }
            } else if (step === 3) {
                // B3: Quét giỏ
                if (value === "@Model.BasketId") {
                    const data = {
                        pickTaskId: "@Model.Id",
                        pickTaskDetailId: "@currentDetail.Id",
                        basketId: "@Model.BasketId"
                    };

                    const res = await fetch("/api/PickTasks/confirm-basket", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(data)
                    });

                    if (res.ok) {
                        showSuccess("🎉 Hoàn tất PickTaskDetail!");
                    } else {
                        const body = await res.json();
                        showError(body.errors?.join("<br>") ?? "❌ Xác nhận thất bại.");
                    }

                    step = 1;
                    picked = 0;
                    qtyPickedEl.textContent = 0;
                } else {
                    showError("❌ Sai giỏ. Hãy thử lại.");
                }
            }
        });

        function showSuccess(msg) {
            resultBox.className = "alert alert-success";
            resultBox.innerHTML = msg;
            resultBox.classList.remove("d-none");
        }

        function showError(msg) {
            resultBox.className = "alert alert-danger";
            resultBox.innerHTML = msg;
            resultBox.classList.remove("d-none");
        }
    </script>
}

